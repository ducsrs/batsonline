---
title: "Bats-DataManip"
author: "Shelby Cline"
date: '2022-06-27'
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(readxl)
bats <- readRDS('bats.RData')
bats <- bats %>%
  mutate(year = year(DATE),
         monthN = month(DATE),
         month = month.abb[monthN],
         hour = hour(TIME),
         sensor = paste(COMPARTMENT,SITE, sep='_') ) %>%
  filter( AUTO.ID != 'Noise' )
# Any bat listed as CORTOW should be listed as CORRAF (Amy text)
bats <- bats %>%
  mutate( AUTO.ID = gsub("CORTOW", "CORRAF", AUTO.ID) )
```
```{r}
# species call counts by year -----
No.ID <- c('NoId', 'NoID', 'Noise')
bats.time <- bats %>%
  filter(! AUTO.ID %in% No.ID, year < 2022) %>%
  group_by(year, AUTO.ID) %>%
  tally()
ggplot(data=bats.time, aes(x=year, y=n, color=AUTO.ID) )+
  geom_line()+
  labs(title = 'Number of Total Calls Per Species',
       subtitle = "From 2017-2021",
       x = 'Year', y = 'Number of Calls')
```
```{r}
# my goal is to group everything and then use summarize so that I can have the total frequency of the bats by species across months.
freq_by_month <- bats %>%
  group_by(year, monthN, AUTO.ID) %>%
  filter(! AUTO.ID %in% No.ID) %>%
  summarize(frequencies = n())
# With the graph, I want to filter to keep only specific year and species combinations for clarity, and I want months to be on the x-axis and the number of calls recorded on the y.
chosen_species <- levels(factor(freq_by_month$AUTO.ID))
ggplot(data = freq_by_month %>% filter(AUTO.ID %in% chosen_species, year == 2017),
       aes(x = monthN,
           y = frequencies,
           color = AUTO.ID))+
  geom_line()
bats %>%
  group_by(AUTO.ID) %>%
  tally()
```
```{r}
# account for number of sensors active on each date -----
bats.daily <- bats %>%
  group_by(DATE) %>%
  mutate( nSensors = length(unique(sensor)) )
bats.daily <- bats.daily %>%
   filter(! AUTO.ID %in% No.ID) %>%
  group_by(DATE,AUTO.ID) %>%
  summarize( count = n(),
             relFreq = count/nSensors )
bats.daily <- distinct(bats.daily)
chosen_species <- levels(factor(bats.daily$AUTO.ID))
# wanting to graph just to see what they all look like over time
ggplot(data = bats.daily %>% filter(AUTO.ID %in% chosen_species)) +
         geom_line(aes( x = DATE,
                 y = count,
                 color = AUTO.ID,
                 alpha = 0.7))
# now i would like to look at just MYOTIS species
ggplot(data = bats.daily %>% filter(AUTO.ID == 'MYOLUC'))+
  geom_line(aes(x = DATE,
                 y = count,
                color = 'pink')) +
  labs(title = 'Little Brown Bat Frequencies',
       subtitle = 'Across all Available Years',
       x = 'Year',
       y = 'Frequency')
```
```{r}
# the goal here was to create a data frame containing the amount of frequencies recorded of a specific species at a specific sensor
selected_year <- 2017
bats.ym <- bats %>%
  group_by(year, month, AUTO.ID, sensor) %>%
  tally()
# then we graphed it and facet-wrapped by sensor to look into each individual one with available data
ggplot(data = bats.ym %>% filter(year == selected_year),
       aes(x = month,
           y = n,
          fill = AUTO.ID))+
  geom_col(position = "dodge")+
  facet_wrap(~sensor)
```
```{r}
# want to create a column of cave obligates versus non-cave obligates to observe their activity
cave_obligate = c('PERSUB', 'MYOLEI', 'MYOAUS', 'MYOLUC', 'MYOSOD', 'MYOGRI', 'MYOSEP')
non_cave_obligate = c('LASBOR', 'NYCHUM', 'EPTFUS', 'LASNOC', 'LASCIN', 'CORRAF')
test <- bats %>%
  mutate(`cave obligate?` = ! AUTO.ID %in% non_cave_obligate) %>%
  group_by(monthN, `cave obligate?`, year) %>%
  filter(monthN == 12) %>%
  tally()
ggplot(data = test,
       aes(x = year,
           y = n,
           color = `cave obligate?`))+
  geom_line()
# theres a sharp dip in frequencies of both bats in 2020. interesting.
```