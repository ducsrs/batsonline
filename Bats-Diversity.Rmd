---
title: 'Bats: Diversity Trends'
author: "Hallie Rutten, Shelby Cline, Monae Scott"
date: '2022-06-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# basic read -----
source('dataRead.R')
bats <- bats 
  rename( siteID = sensor) %>% 
  select(-LATITUDE,-LONGITUDE)

# sensor data read -----
source('dataRead-sensorDates.R')
  
# join bats and sensor site data -----
bats <- left_join(bats,sensorDates, by=c('siteID','DATE'))
```

# Diversity (species) Trends

Big Graph

```{r}
  
# by changing the x-axis value, we can create a couple of different graphs to include on the tab to tell different stories

bats.per <- bats %>% 
  filter(! grepl('Noise', AUTO.ID, ignore.case = TRUE)) %>% 
  group_by(year) %>% 
  mutate(tot_bat = n())

bats.per <- bats.per %>% 
  mutate(year = factor(year, levels = min(bats.per$year):max(bats.per$year))) %>% 
  group_by(year, AUTO.ID, Common) %>% 
  summarise(prop = n()/tot_bat, 
            perc = prop*100)

bats.per <- distinct(bats.per)


diversity_graph <- ggplot(data = bats.per)+
  geom_col(aes(x = year,
               y = perc,
               fill = AUTO.ID, 
               text = paste("Percentage:",round(prop*100, 1),
                            "Species:", Common)))


ggplotly(diversity_graph, tooltip = c("fill", "text"))

```




Exploratory Analysis


# trying to learn plotly

# commented this out as the one below is better but i might need this if i mess it up too far
# bats.per <- bats %>% 
 # filter(! grepl('Noise', AUTO.ID, ignore.case = TRUE)) %>% 
#  group_by(year, COMPARTMENT) %>% 
 # mutate(tot_bat = n())

#bats.per <- bats.per %>% 
 # group_by(year, AUTO.ID, COMPARTMENT) %>% 
 # summarise(prop = n()/tot_bat, 
  #          perc = prop*100)

# bats.per <- distinct(bats.per)


# diversity_graph <- ggplot(data = bats.per)+
 # geom_col(aes(x = year,
   #            y = perc,
     #          fill = AUTO.ID, 
    #           text = paste("Compartment:", COMPARTMENT,
             #               "Percentage:", prop*100)))


# ggplotly(diversity_graph, tooltip = c("fill", "text"))

```{r}
# account for number of sensors active on each date -----
bats.daily <- bats %>%
  group_by(DATE) %>%
  mutate( nSensors = length(unique(sensor)) )
bats.daily <- bats.daily %>%
  filter(! AUTO.ID %in% No.ID) %>%
  group_by(DATE,AUTO.ID) %>%
  summarize( count = n(),
             relFreq = count/nSensors )
bats.daily <- distinct(bats.daily)
chosen_species <- levels(factor(bats.daily$AUTO.ID))
# wanting to graph just to see what they all look like over time
ggplot(data = bats.daily %>% filter(AUTO.ID %in% chosen_species)) +
         geom_line(aes( x = DATE,
                 y = count,
                 color = AUTO.ID,
                 alpha = 0.7))
# now i would like to look at just MYOTIS species
ggplot(data = bats.daily %>% filter(AUTO.ID == 'MYOLUC'))+
  geom_line(aes(x = DATE,
                 y = count),
            color = 'blue') +
  labs(title = 'Little Brown Bat Frequencies',
       subtitle = 'Across all Available Years',
       x = 'Year',
       y = 'Frequency')
```

```{r}
# my goal here is to try and understand trends between EPTFUS and MYOLUC, maybe a cute lil facet wrap for sensors so that I can see if any of them are/were in the same place. anyways

big_v_lil <- bats %>% 
  group_by(AUTO.ID, sensor, DATE) %>% 
  filter(AUTO.ID %in% c('MYOLUC','EPTFUS')) %>% 
  tally()

ggplot(data = big_v_lil)+
  geom_line(aes(x = DATE,
                y = n,
                color = AUTO.ID))+
  labs(title = 'EPTFUS vs. MYOLUC Presence',
       x = 'Date',
       y = 'Number of Recordings')+
  facet_wrap(~sensor)

# taking a closer look at one of the censors with a lot of activity
ggplot(data = big_v_lil %>% filter(sensor == "C22_S9"))+
  geom_line(aes(x = DATE,
                y = n,
                color = AUTO.ID))+
  labs(title = 'EPTFUS vs. MYOLUC Presence',
       x = 'Date',
       y = 'Number of Recordings')

# i would love if we put this on the dashboard, if you could choose which sensor graph youre looking at
```


```{r}

bats.prop <- bats %>% 
  filter(! grepl('Noise', AUTO.ID, ignore.case = TRUE)) %>% 
  group_by(year) %>% 
  mutate(tot_bat = n())

bats.prop <- bats.prop %>% 
  group_by(year, AUTO.ID) %>% 
  summarise(prop = n()/tot_bat, 
            perc = prop*10)

bats.prop <- distinct(bats.prop)
  
 ggplot(data = bats.prop)+
   geom_line(aes(x = year,
                 y = prop,
                 color = AUTO.ID))
```



