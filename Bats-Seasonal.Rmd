---
title: 'Bats: Seasonal Trends'
author: "Hallie Rutten, Shelby Cline, Monae Scott"
date: '2022-06-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(dplyr)
bats <- readRDS('bats.RData')


bats <- bats %>% 
  mutate(year = year(DATE), 
         monthN = month(DATE),
         month = month.abb[monthN],
         hour = hour(TIME) ) %>% 
  filter(! AUTO.ID %in% c( "NoId", "NoID", "Noise" ))

# Any bat listed as CORTOW should be listed as the secondary species
bats <- bats %>% 
  mutate( AUTO.ID = gsub("CORTOW", 
                         unlist(strsplit(ALTERNATES, split=';', fixed=TRUE))[1],
                         AUTO.ID) )
```

# Seasonal (monthly) Trends

```{r}


library(readxl)
#read in daily weather data
weather <- read_xlsx("SUD Weather Station.xlsx")

#read in hourly weather data
hourly<-read_xlsx("SUD Weather Station.xlsx", sheet=2)

#read in recorded rain data
rain<-read_xlsx("SUD Weather Station.xlsx", sheet = 3)


#create a variable for  average temp. by month
# DailyTemp<-weather %>% 
#   group_by(month(weather$`Timestamp*`)) %>% 
#   summarize(mean_temp = mean(`Air temp Avg (C)`)) 

#simple plot for weather (average daily temp)
###bat activity month column 1-12, rain has month column

```

```{r}
#rename column names in weather df
colnames(weather)
weather <- weather %>%
  dplyr::rename("Date" = "Timestamp*",
         AvgTemp='Air temp Avg (C)',
         Highest_Temp_Time='Time Air Temp Max',
         MaxTemp='Air Temp Max (C)',
         MinTemp='Air Temp Min',
         MaxWind='Wind Speed Max (low) (m/s)',
         AvgWind='Wind Speed Avg (high) (m/S)',
         MinWind='Wind Speed Min (low) (m/s)')

#variable with date, wind cols and temp cols
#Daily_Weather<-DailyTemp %>% 

#
hourly<-hourly %>% 
  mutate(Date= date(Timestamp)) 

#create 'rainfall' variable to get the avg. rainfall per recorded day 
rainfall<-hourly %>%  
  group_by(Date) %>% 
  summarise(total_rainfall = sum(`Rain (mm)`))


#rainfall monthly for each year
hourly<-hourly %>% 
  mutate(Month= month(Timestamp)) 

#rainfall yearly
hourly<-hourly %>% 
  mutate(Year= year(Timestamp))

yearly_rainfall <- hourly %>% 
  drop_na( Year ) %>% 
  group_by(Year) %>%
  summarise(yearly_rainfall= sum(`Rain (mm)`)) 
View(yearly_rainfall)  

#ignoring 2017 and NA bc it wasn't enough data
monthly_rainfall<-hourly %>%  
  group_by(Month,Year) %>% 
  summarise(total_monthly_rainfall = sum(`Rain (mm)`)) %>% 
  filter(Year>2017)
View(monthly_rainfall)

df <- bats %>% 
  mutate(Month= month(DATE)) %>% 
  mutate(Year= year(DATE)) %>% 
  group_by(Month, Year, AUTO.ID) %>% 
  tally() %>%
  ungroup()

df <- left_join(df, monthly_rainfall, by=c('Month', 'Year'))
  
#plot monthly rainfall 
ggplot(data = monthly_rainfall, aes(x=Month, y=total_monthly_rainfall, fill=Year))+
  geom_area()+
  labs(title='Monthly Rainfall by Year', caption = 'Sewanee Bat Study. DataLab 2022', y='Total Rainfall (mm)')+
  facet_wrap(~Year)+
   theme( legend.position = "none" ) +
  scale_x_continuous(breaks = 1:12)

#plot monthly rainfall with bat trends
df %>% 
  filter(Year>2017)

```

```{r}
library(ggplot2)
#create Year and Month variable from Date column
df <- df %>% 
  mutate( Date = ymd(paste0( Year, "-", Month, "-1") ) )
view(df)
#filter out 2017 and 2022; not enough data
df<-df%>% 
  filter(Year>2017, Year<2022)

```

```{r}
#convert temp.from Celsius to Fahrenheit#
#Max temp
Fahrenheit<-weather %>% 
  mutate(MaxTemp_f = MaxTemp*(9/5)+32)

#Min temp
Fahrenheit<-Fahrenheit %>% 
  mutate(MinTemp_f = MinTemp*(9/5)+32)

#Average temp
Fahrenheit<-Fahrenheit %>% 
  mutate(AvgTemp_f = AvgTemp*(9/5)+32)

#merge df and fahrenheit
#first need to create a month and year column in Fahrenheit data set

Fahrenheit<-Fahrenheit %>% 
  mutate(Month= month(Date)) %>% 
  mutate(Year= year(Date))


#Get the mean of min, max, and average temp to plot better.
df.2<-Fahrenheit %>%  
  group_by(Month, Year) %>% 
  summarise(AvgTemp_f = mean(`AvgTemp_f`),
            MaxTemp_f = mean(`MaxTemp_f`),
            MinTemp_f = mean(`MinTemp_f`),
            drop_na(df.2))


#plot max, min, avg temp 
ggplot(data = df.2, aes(x=Month, ymin=MinTemp_f, ymax=MaxTemp_f, y=AvgTemp_f))+
  scale_color_gradient2(low = "blue", mid = muted("blue"), high = "red", midpoint = median(df.2$AvgTemp_f))+
  geom_ribbon(fill = "lightpink")+
  geom_line(color="red")+
  labs(title = 'Temperature ', subtitle = 'Maximum, Minimum, and Average', caption = 'Sewanee Bat Study. DataLab 2022', y='Temperature (Â°F)')+
  facet_wrap(~Year)+
  scale_x_continuous(breaks = 1:12)
  
  

  

```

```{r}
#wind monthly for each year
windy<-weather %>% 
  mutate(Month= month(Date)) %>% 
  mutate(Year= year(Date))

#mean of wind ?intensity? 
df.3<-windy %>%  
  group_by(Month, Year) %>% 
  summarise(AvgWind = mean(`AvgWind`),
            MaxWind = mean(`MaxWind`),
            MinWind = mean(`MinWind`),
            drop_na(df.3))


  
#plot wind ?intensity? 



ggplot(data = df.3, aes(x=Month, ymin=MinWind, ymax=MaxWind, y=AvgWind))+
  geom_ribbon(fill = "gray")+
  geom_line(color="darkgray")+
  labs(title='Monthly Wind Intensity', subtitle = 'By year', caption= 'Sewanee Bat Study. DataLab 2022',y='Total Wind Speed (m/s)')+
  facet_wrap(~Year)+
   theme( legend.position = "none" ) +
  scale_x_continuous(breaks = 1:12)

```

```{r}
#overall temp. trends across the years on one graph
#just the average

#mean of temp
df.2<-df.2 %>%  
  group_by(Month, Year) %>% 
  summarise(AvgTemp_f = mean(`AvgTemp_f`),
            MaxTemp_f = mean(`MaxTemp_f`),
            MinTemp_f = mean(`MinTemp_f`),
            drop_na(df.2))
ggplot(data=df.2, aes(x=Month, y=AvgTemp_f, color=Year))+
  geom_line()
```