---
title: 'Bats: Seasonal Trends'
author: "Hallie Rutten, Shelby Cline, Monae Scott"
date: '2022-06-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(dplyr)
bats <- readRDS('bats.RData')


bats <- bats %>% 
  mutate(year = year(DATE), 
         monthN = month(DATE),
         month = month.abb[monthN],
         hour = hour(TIME) ) %>% 
  filter(! AUTO.ID %in% c( "NoId", "NoID", "Noise" ))

# Any bat listed as CORTOW should be listed as the secondary species
bats <- bats %>% 
  mutate( AUTO.ID = gsub("CORTOW", 
                         unlist(strsplit(ALTERNATES, split=';', fixed=TRUE))[1],
                         AUTO.ID) )
```

# Seasonal (monthly) Trends

```{r}


library(readxl)
#read in daily weather data
weather <- read_xlsx("SUD Weather Station.xlsx")

#read in hourly weather data
hourly<-read_xlsx("SUD Weather Station.xlsx", sheet=2)

#read in recorded rain data
rain<-read_xlsx("SUD Weather Station.xlsx", sheet = 3)

#simple plot for weather (average daily temp)
###bat activity month column 1-12, rain has month column

```

```{r}
#rename column names in weather df
colnames(weather)
weather <- weather %>%
  dplyr::rename("Date" = "Timestamp*",
         AvgTemp='Air temp Avg (C)',
         Highest_Temp_Time='Time Air Temp Max',
         MaxTemp='Air Temp Max (C)',
         MinTemp='Air Temp Min',
         MaxWind='Wind Speed Max (low) (m/s)',
         AvgWind='Wind Speed Avg (high) (m/S)',
         MinWind='Wind Speed Min (low) (m/s)')

#variable with date, wind cols and temp cols
#Daily_Weather<-DailyTemp %>% 

#
rain %>% 
  mutate(Date = date(Timestamp)) %>% 
  mutate(year = year(Date)) %>% 
  group_by(year) %>% 
  summarize(dates = length(unique(Date))) %>% 
  View

hourly<-hourly %>% 
  mutate(Date= date(Timestamp)) 

#create 'rainfall' variable to get the avg. rainfall per recorded day 
daily_rainfall<-hourly %>%  
  mutate(Month= month(Timestamp)) %>% 
  mutate(Year= year(Timestamp)) %>% 
  group_by(Year, Date, Month) %>% 
  summarise(total_rainfall = sum(`Rain (mm)`),
            total_hours = n()) %>% 
  mutate(mm_hr = total_rainfall / total_hours) %>% 
  mutate(mm_predicted = mm_hr * 24) 

#rainfall monthly for each year
#hourly<-hourly %>% 
#  mutate(Month= month(Timestamp)) 

#rainfall yearly
#hourly<-hourly %>% 
#  mutate(Year= year(Timestamp))

yearly_rainfall <- daily_rainfall  %>% 
  drop_na( Year ) %>% 
  group_by(Year) %>%
  summarise(rain_intensity= sum(total_rainfall)/sum(total_hours)) 
View(yearly_rainfall)  

#ignoring 2017 and NA bc it wasn't enough data
monthly_rainfall<-daily_rainfall %>%  
  group_by(Month,Year) %>% 
  summarise(rain_intensity= sum(total_rainfall)/sum(total_hours)) 
View(monthly_rainfall)

df <- bats %>% 
  mutate(Month= month(DATE)) %>% 
  mutate(Year= year(DATE)) %>% 
  group_by(Month, Year, AUTO.ID) %>% 
  tally() %>%
  ungroup()

df <- left_join(df, monthly_rainfall, by=c('Month', 'Year'))
 
###
df %>% 
  filter(Year>2017) 
#plot monthly rainfall 
ggplot(data = monthly_rainfall, aes(x=Month, y=rain_intensity, fill=Year))+
  geom_area()+
  labs(title='Monthly Rainfall by Year', caption = 'Sewanee Bat Study. DataLab 2022', y='Total Rain Intensity (mm/hr)')+
  facet_wrap(~Year)+
   theme( legend.position = "none" ) +
  scale_x_continuous(breaks = 1:12)

###calculate the total rain for the year
#group by day
#Get the average rain intensity for the day 
#Multiply the average by the numb of sec in a day
#That gives me daily rainfall and It can be summed up for monthly, yearly

### do i need to mutate the date variable to get the day from it? total rain fall df has all the rain for each day summarized already 

rainfall <- rainfall %>% 
  mutate(Day= day(Date)) %>% 
  group_by(Day) %>% 
  summarise(total_rainfall=mean(total_rainfall*86400))

###not sure if i did this correctly...###




```

```{r}
library(ggplot2)
#create Year and Month variable from Date column
df <- df %>% 
  mutate( Date = ymd(paste0( Year, "-", Month, "-1") ) )
view(df)
#filter out 2017 and 2022; not enough data
df<-df%>% 
  filter(Year>2017, Year<2022)

```

```{r}
#convert temp.from Celsius to Fahrenheit#
#Max temp
Fahrenheit<-weather %>% 
  mutate(MaxTemp_f = MaxTemp*(9/5)+32)

#Min temp
Fahrenheit<-Fahrenheit %>% 
  mutate(MinTemp_f = MinTemp*(9/5)+32)

#Average temp
Fahrenheit<-Fahrenheit %>% 
  mutate(AvgTemp_f = AvgTemp*(9/5)+32)

#merge df and fahrenheit
#first need to create a month and year column in Fahrenheit data set

Fahrenheit<-Fahrenheit %>% 
  mutate(Month= month(Date)) %>% 
  mutate(Year= year(Date))


#Get the mean of min, max, and average temp to plot better.
df.2<-Fahrenheit %>%  
  group_by(Month, Year) %>% 
  summarise(AvgTemp_f = mean(`AvgTemp_f`),
            MaxTemp_f = mean(`MaxTemp_f`),
            MinTemp_f = mean(`MinTemp_f`))

drop_na(df.2)

df.2<-df.2%>% 
  filter(Year>2017, Year<2022)
#plot max, min, avg temp 
ggplot(data = df.2, aes(x=Month, ymin=MinTemp_f, ymax=MaxTemp_f, y=AvgTemp_f))+
  geom_ribbon(fill = "lightpink")+
  geom_line(color="red")+
  labs(title = 'Temperature ', subtitle = 'Maximum, Minimum, and Average', caption = 'Sewanee Bat Study. DataLab 2022', y='Temperature (°F)')+
  facet_wrap(~Year)+
  scale_x_continuous(breaks = 1:12)
  
  

  

```

```{r}
#wind monthly for each year
windy<-weather %>% 
  mutate(Month= month(Date)) %>% 
  mutate(Year= year(Date))

#mean of wind ?intensity? 
df.3<-windy %>%  
  group_by(Month, Year) %>% 
  summarise(AvgWind = mean(`AvgWind`),
            MaxWind = mean(`MaxWind`),
            MinWind = mean(`MinWind`))

drop_na(df.3)

df.3<-df.3%>% 
  filter(Year>2017, Year<2022) 

#plot wind ?intensity? 
ggplot(data = df.3, aes(x=Month, ymin=MinWind, ymax=MaxWind, y=AvgWind))+
  geom_ribbon(fill = "gray")+
  geom_line(color="darkgray")+
  labs(title='Monthly Wind Intensity', subtitle = 'By year', caption= 'Sewanee Bat Study. DataLab 2022',y='Total Wind Speed (m/s)')+
  facet_wrap(~Year)+
   theme( legend.position = "none" ) +
  scale_x_continuous(breaks = 1:12)

```

```{r}
#overall temp. trends across the years on one graph
#just the average

#mean of temp
yearly_rainfall<-yearly_rainfall%>% 
  filter(Year>2017, Year<2022)

ggplot(data=df.2, aes(x=Month, y=AvgTemp_f, group=Year, color=Year))+
  geom_line()+
  labs(title = 'Overall Averages for Temperature ', caption = 'Sewanee Bat Study. DataLab 2022', y='Temperature (°F)')+
  scale_x_continuous(breaks = 1:12)


```

```{r}
#plot yearly rainfall

ggplot(data = yearly_rainfall, aes(x=Year, y=yearly_rainfall, fill=Year))+
  geom_col()+
  theme( legend.position = "none" ) +
  labs(title='Overall Rainfall', caption = 'Sewanee Bat Study. DataLab 2022', y='Total Rainfall (mm)')

```

```{r}
source('dataRead-bats.R')
library(readxl)
batspecies <- read_excel("BatSpecies.xlsx")

bats <- bats %>%  
  rename( siteID = sensor) %>% 
  select(-LATITUDE,-LONGITUDE)
# sensor data read -----
source('dataRead-sensorDates.R')
  
# join bats and sensor site data -----
bats <- left_join(bats,sensorDates, by=c('siteID','DATE'))
No.ID = c("Noise", "NoId", "NoID")  


bats<-left_join(bats,batspecies, by="AUTO.ID")
###
bats.time <- bats %>%
  filter(! AUTO.ID %in% No.ID, year < 2022) %>%
  group_by(year) %>%
  mutate(nsensors = length(unique(siteID)))
# another code segment to utilize another group_by, this time so i can see the relative frequency of the species per year
bats.time <- bats.time %>% 
  group_by(monthN, year, AUTO.ID) %>% 
  summarize(count = n(),
            rel_freq = count/nsensors)
bats.time <- unique(bats.time)


#this is just the plot, its copied almost exactly below so we could put it inside of an object to be used in the ggplotly function.

bats.time<-bats.time%>% 
  filter(year>2017, year<2022)

ggplot(data=bats.time,
       aes(x=monthN,
           y=rel_freq,
           color=AUTO.ID) )+
  geom_line()+
  facet_wrap(~year)+
  labs(title = 'Number of Total Calls Per Species',
       subtitle = "From 2017-2021",
       x = 'Year', y = 'Number of Calls')+
    scale_x_continuous(breaks = 1:12)

longterm_graph <- ggplot(data=bats.time, 
                         aes(x=monthN,
                             y=rel_freq, 
                             color=AUTO.ID) )+
  geom_line()+
  labs(title = 'Number of Total Calls Per Species',
       subtitle = "From 2017-2021",
       x = 'Year', y = 'Number of Calls')
# using hovertemplate allows us to zoom into the graph
ggplotly(longterm_graph, hovertemplate = paste())      
```




