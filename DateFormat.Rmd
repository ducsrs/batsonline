---
title: "Data Date Exploration"
author: "Hallie Rutten, Shelby Cline, Monae Scott"
date: '2022-06-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(lubridate)
library(hms)
```

Before you run this code, make sure you...
- have a folder called 'Data' that holds all the compartments and sub-folders
- set your session working directory in the same place this 'Data' folder is
- ideally have this markdown file in the same place as the 'Data' folder

## Reading path names

```{r}
# get all file path names in Data folder -----
files <- paste0('Data/',dir('Data/',recursive=TRUE))

# filter out non-data files -----
files <- data.frame(files) %>% 
  filter( grepl("Compartment",files) )

# get the path names of all the raw data files -----
files.data <- files %>% 
  filter( !grepl("idsummary",files), grepl(".csv$|.xls$|.xlsx$",files) )

# get the path names of all the summary data files -----
files.summaries <- files %>% 
  filter( grepl("idsummary",files) )

# get the path names of all the other files -----
files.other <- files %>% 
  filter( !grepl("idsummary",files), !grepl(".csv$|.xls$|.xlsx$",files) )
```

## Reading the data

```{r}
# reading in the data -----

# variables to keep
standard <- c('AUTO.ID', 'DATE', 'HOUR', 'TIME','LONGITUDE','LATITUDE')
# LONGITUDE and LATITUDE are not in all of them
merges <- c('ALTERNATES','ALTERNATE.1','ALTERNATE.2')

# empty data frame to hold the data
bats <- data.frame()

# for every file path in the data.files set...
for(file in files.data$files){
  
  # let us know what file it's working on
  message(file)
  # set 'vars' to be an empty vector (for the variable names)
  vars <- c()
  # set 'temp' to be an empty data frame (for the data)
  temp <- data.frame()
  
  # if the file is a csv, try read_csv
  if( grepl('.csv',file) ){
    try( temp <- read_csv(file, show_col_types=FALSE) )
  } 
  #if it's an excel, try read_excel
  if( grepl('.xls|.xlsx',file) ){
    try( temp <- read_excel(file) )
  }
  
  # if we accidentally read in a summary file, reset 'temp' to an empty data frame
  if( length(temp)>0 & grepl("KALEIDOSCOPE", paste(names(temp),sep='',collapse=' ')) ){ 
    temp <- data.frame() 
  }
  
  # if we got data from the reads (aka if 'temp' is no longer empty)...
  if( length(temp)>0 ){
    
    # change variable names to uppercase
    names(temp) <- toupper(names(temp))
    # clean up the formatting
    names(temp) <- gsub(" ",".",names(temp))
    names(temp) <- gsub("-",".",names(temp))
    names(temp) <- gsub("*","",names(temp))
    names(temp) <- gsub("AUTO.ID.","AUTO.ID",names(temp))
    # get the cleaned variable names
    vars <- names(temp)
    # collapse the vector into a single string
    vars <- paste(vars,sep='',collapse=' ')
    
    # check if it has ALTERNATE.1 and ALTERNATE.2
    if( grepl('ALTERNATE.1',vars) & grepl('ALTERNATE.1',vars) ){
      temp <- temp %>% 
        mutate( ALTERNATES = paste(c(ALTERNATE.1,ALTERNATE.2),sep='',collapse=';') )
    }#--end alternates 1 and 2 check ---
    # check if it doesn't have ALTERNATES
    if( !grepl('ALTERNATES',vars) ){
      temp['ALTERNATES'] <- NA
    }#--end missing alternates var creation--
    
    # for each standard variable we need...
    for(var in standard){
      # check to make sure it's in the variables string
      # if any given one is missing, make an empty column for it
      if( !grepl(var, vars) ){ temp[var] <- NA }
    }#--end standard var check loop--
    
    # select only the variables we want
    temp <- temp %>% select(AUTO.ID, DATE, HOUR, TIME, ALTERNATES, LATITUDE, LONGITUDE)
    # make sure DATE and TIME are in the proper format
    temp <- temp %>% mutate( DATE = as.character(DATE), TIME = as_hms(TIME) )
    
    # break the file path up by '/'s
    C_S <- unlist( strsplit(file, split = "/") )
    #get the index of the piece that contains 'Compartment'
    idx <- which(grepl("Compartment",C_S))
    # if it's the Compartment 22-Firelane folder...
    if( grepl("Firelane", C_S[ idx ], ignore.case=TRUE) ){
      # get the portion that contains 'Compartment'
      C_S <- C_S[idx]
      # break it up by '-' (so it makes "Compartment 22" and "Firelane")
      C_S <- unlist( strsplit(C_S, split="-") )
      # record compartment and change 'Compartment 22' into 'C22'
      compartment <- gsub("Compartment ","C",C_S[1],ignore.case=TRUE)
      # record the site (which will be 'Firelane')
      site <- C_S[2]
    } 
    # otherwise, if it's a standard compartment...
    else {
      # get the portion after the one that contains 'Compartment'
      C_S <- C_S[ idx+1 ]
      # break up by '_', since the standard format is C#_S#
      C_S <- unlist( strsplit(C_S, split="_") )
      # record compartment
      compartment <- C_S[1]
      # record site
      site <- C_S[2]
    }
    # replace all the P# sites with S# sites
    site <- gsub("P","S",site)
    # if there's a space (like from 'C53_P1 (S4Z00723)') keep only the first bit
    if( grepl(" ",site) ){ site <- unlist( strsplit(site, split=' ') )[1] }
    # if site is just a number and not 'Firelane'...
    if( !grepl("S",site) & !grepl("Firelane",site,ignore.case=TRUE) ){
      # put an 'S' in front of it
      site <- paste0('S',site)
    }
    # add them to the data set
    temp['COMPARTMENT'] <- compartment
    temp['SITE'] <- site
    
    # record the file path to original data
    # in case we find something wacky we want to look into
    temp['path'] <- file
    
    # combine the current data set with the overall data set
    bats <- rbind( bats, temp )
    
  }#--end temp not null loop--
  
}#--end big loop--
```

## Fixing the dates

```{r}
# get the dates -----
dates <- bats$DATE

# looking at the bad dates -----
badDates <- dates[ which(grepl('/',dates)) ]
head(badDates)
tail(badDates)


# testing on only the bad dates -----
for(i in 1:length(badDates) ){
  dt <- unlist(strsplit(badDates[i],split='/'))
  badDates[i] <- paste0(dt[3],"-",dt[1],"-",dt[2])
}
head(badDates)
tail(badDates)

badDates <- as.Date(badDates)
head(badDates)
tail(badDates)


# testing on all the dates -----
for(i in 1:length(dates) ){
  if( grepl('/',dates[i]) ){
    dt <- unlist(strsplit(dates[i],split='/'))
    dates[i] <- paste0(dt[3],"-",dt[1],"-",dt[2])
  }
}
dates <- as.Date(dates)
```

```{r}
# adapt to data.frame -----
fixDate <- function( date ){
  if( grepl('/',date) ){
    dt <- unlist(strsplit(date,split='/'))
    # assume month/day/year format
    date <- paste0(dt[3],"-",dt[1],"-",dt[2])
  }
  return(date)
}
fixDates <- function( date ){
  for(i in 1:length(date) ){
    if( grepl('/',date[i]) ){
      dt <- unlist(strsplit(date[i],split='/'))
      date[i] <- paste0(dt[3],"-",dt[1],"-",dt[2])
    }
  }
  return(date)
}

bat.dates <- bats %>% 
  select( DATE, COMPARTMENT, SITE, path ) 

bat.dates <- bat.dates %>% 
  mutate( date = as.Date(fixDates(DATE)) )

bat.dates <- bat.dates %>% 
  mutate( year = year(date),
          month = month(date), 
          day = day(date) )

range( bat.dates$year )
range( bat.dates$month )
range( bat.dates$day )

sort(unique( bat.dates$year ))
sort(unique( bat.dates$month ))
sort(unique( bat.dates$day ))
```

## Invesigating the 2000's entries

```{r}
bats2000 <- bat.dates %>% 
  filter( grepl('2000', DATE, ignore.case=TRUE) )
sort(unique( bats2000$COMPARTMENT ))
sort(unique( bats2000$SITE ))
sort(unique( bats2000$month ))
sort(unique( bats2000$day ))
unique( bats2000$path )

# Data/Compartment 53/C53_P1 (S4Z00723)/FY22/1.24.22-2.3.22/C53_P1_1.24.22_2.3.22.csv

# Data/Compartment 53/C53_P1 (S4Z00723)/FY22/2.3.22-3.29.22/C53_P1_2.3.22_3.29.22.csv

temp2000.1 <- read_csv('Data/Compartment 53/C53_P1 (S4Z00723)/FY22/1.24.22-2.3.22/C53_P1_1.24.22_2.3.22.csv', 
                       show_col_types=FALSE) %>% filter( year(DATE)==2000 )

temp2000.2 <- read_csv('Data/Compartment 53/C53_P1 (S4Z00723)/FY22/2.3.22-3.29.22/C53_P1_2.3.22_3.29.22.csv', 
                       show_col_types=FALSE) %>% filter( year(DATE)==2000 )

length( bats2000$DATE )

length( temp2000.1$DATE ) + length( temp2000.2$DATE )
```

Looks like there was some mis-entered data; 
replacing all 2000's with 2022's should fix it









